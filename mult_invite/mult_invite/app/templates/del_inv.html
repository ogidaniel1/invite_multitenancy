{% extends "base.html" %}

{% block title %}Invitees | Admin Dashboard{% endblock %}

{% block header_title %}Manage Invitees{% endblock %}

{% block content %}

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Invitees</title>

  <!-- CSRF token -->
  <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}


  <div class="container">
    <h1>{{ event.name }}, Invitees</h1>
    <strong><p>Welcome, {{ current_user.name }}!</p></strong>
    <strong><p>Scan Attendees QR code to Mark Attendance</p></strong>

    <!-- Search -->
    <div class="mb-3">
      <form method="GET"
            action="{{ url_for('inv.manage_invitee', org=org, org_uuid=org.uuid, invitees=invitees, event_id=event.id) }}"
            class="form-horizontal">
        <div class="input-group">
          <input type="text" name="search" class="form-control"
                 placeholder="Search Invitee by email or phone number"
                 value="{{ request.args.get('search', '') }}">
          <button type="submit" class="btn btn-primary">Search</button>
        </div>
      </form>
    </div>

    {% if current_user.is_super_admin or current_user.is_org_admin %}
      <div class="mb-3">
        <a href="{{ url_for('inv.show_invitees', org_uuid=org.uuid, event_id=event.id) }}" class="btn btn-secondary">
          Back
        </a>
      </div>
    {% endif %}
    <div class="text-end mb-3">
      <a href="{{ url_for('inv.show_invitee_event', org_uuid=org.uuid, event_id=event.id) }}"
         class="btn btn-sm btn-outline-primary">Event detail</a>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="table table-striped">
        <thead>
          <tr class="text-center">
            <th>ID</th>
            <th>Name</th>
            <th>Phone Number</th>
            <th>State</th>
            <th>LGA</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for invitee in invitees %}
            <tr id="invitee-row-{{ invitee.id }}">
              <td>{{ invitee.id }}</td>
              <td>{{ invitee.name }}</td>
              <td>{{ invitee.phone_number }}</td>
              <td>{{ invitee.state }}</td>
              <td>{{ invitee.lga }}</td>
              <td>{{ invitee.confirmed }}</td>
              <td>
                <!-- <div class="btn-group"> -->

                  {% if current_user.is_super_admin or current_user.is_org_admin %}

                  <!-- Edit -->
                  <a href="{{ url_for('inv.edit_invitee', org_uuid=org.uuid, id=invitee.id, event_id=event.id) }}"
                     class="btn  btn-sm btn-warning me-2">
                     <i class="fas fa-edit"></i> Edit
                  </a>

                  <!-- Remove from Event -->
                  <button class="btn btn-sm btn-secondary me-2"
                          onclick="removeFromEvent('{{ org.uuid }}', {{ event.id }}, {{ invitee.id }})">
                    <i class="bi bi-x-circle"></i> Remove
                  </button>

                  <!-- Permanent Delete -->
                  <button class="btn btn-sm btn-danger me-2"
                          onclick="deleteInvitee('{{ org.uuid }}', {{ invitee.id }})">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                  {% endif %}

                  <!-- Mark Present -->
                  <button class="btn btn-sm btn-success"
                          onclick="markPresent('{{ org.uuid }}', {{ event.id }}, {{ invitee.id }})">
                    <i class="bi bi-check2-circle"></i> Mark
                  </button>
                </div>
              </td>
           {% else %}
            <tr>
                <td colspan="7">No Active Invitees for this Event yet.</td>
            </tr>
            {% endfor %}
        </tbody>
      </table>

      <!-- Pagination -->
      <nav aria-label="Page navigation">
        <ul class="pagination">
          {% if pagination.has_prev %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('inv.show_invitees', org_uuid=org.uuid, page=pagination.prev_num, search=request.args.get('search', '')) }}">
                &laquo;
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><a class="page-link" href="#">&laquo;</a></li>
          {% endif %}

          {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
              {% if page_num == pagination.page %}
                <li class="page-item active"><a class="page-link" href="#">{{ page_num }}</a></li>
              {% else %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('inv.manage_invitee', org_uuid=org.uuid, event_id=event.id, page=page_num, search=request.args.get('search', '')) }}">
                    {{ page_num }}
                  </a>
                </li>
              {% endif %}
            {% else %}
              <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
            {% endif %}
          {% endfor %}

          {% if pagination.has_next %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('inv.show_invitees', org_uuid=org.uuid, page=pagination.next_num, search=request.args.get('search', '')) }}">
                &raquo;
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><a class="page-link" href="#">&raquo;</a></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    // Helper: show bootstrap alert dynamically
    // function showAlert(message, type="success") {
    //   const alertBox = `
    //     <div class="alert alert-${type} alert-dismissible fade show" role="alert">
    //       ${message}
    //       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    //     </div>`;
    //   document.getElementById("ajax-alerts").innerHTML = alertBox;
    // }


// Defined from Flask context
        // const orgUuid = "{{ org.uuid }}";
        
        // Fetch CSRF token from meta tag
        function deleteInvitee(orgUuid,inviteeId) {
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        if (confirm('Are you sure you want to delete this Invitee?')) {
            fetch(`/${orgUuid}/del_invitee/${inviteeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken  // Add CSRF token to request headers
                },
                body:JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // console.log('DELETE URL = /${orgUuid}/del_invitee/${inviteeId}');

                    alert(data.message);
                    window.location.reload();  // Reload the page or update the UI
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error occurred: ' + error);
            });
        }
    }
   
        // Fetch CSRF token from meta tag
        function markPresent(orgUuid, eventId, inviteeId) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        if (confirm('Are you sure you want to Mark this Invitee as Present?')) {
            fetch(`/${orgUuid}/mark_invitee/${eventId}/${inviteeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body:JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error occurred: ' + error);
            });
        }
    }
    // Remove from Event
    function removeFromEvent(orgUuid, eventId, inviteeId) {
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

      if (confirm('Are you sure you want to Remove this Invitee from event?')) {

      fetch(`/${orgUuid}/del_event_invitee/${eventId}/${inviteeId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
        body: JSON.stringify({})
      })
      .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error occurred: ' + error);
            });
        }
    }
    
  </script>

</body>
{% endblock %}
</html>